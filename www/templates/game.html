{% extends "base.html" %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='game.css') }}">
{% endblock %}

{% block content %}

<header>
    <div id="score">Score: 0</div>
</header>
<main>
    <div class="click-button" id="click-button" onclick="handleClick()">
        <span id="start-button-text" class="start-button-text">START</span>
    </div>
    <div class="level" id="level">Level 1</div>
</main>

{% endblock %}

{% block scripts %}

<script>
    let preloaderIsClose = false;
    let score = 0;
    let level = 1;
    let disabled = false;
    let remainingTime = 20.0;

    let accessToken = "";

    const timer = setInterval(() => {
                remainingTime -= 0.1;
                remainingTime = remainingTime.toFixed(1);
                if (remainingTime <= 0 && remainingTime > 20) {
                    clearInterval(timer);
                    disabled = false;
                }
                updateTimer();
            }, 100);

    logging();

    function handleClick() {

        // Увеличиваем очки
        if (!disabled) {
            if (sendMessageAboutClickToServer()) {   
                score++;
                showScore();
                
                // Деактивируем кнопку
                disabled = true;
                remainingTime = 20.0;
                updateTimer();
                
                // Таймер
                setInterval(timer);
                updateTimer();
            }
        }
    

    }


    async function logging() {
        const params = new URLSearchParams(window.location.search);
        user_id = params.get("user_id"); 

        const response = await fetch('/logging', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ user_id }),
        });
        const data = await response.json();
        console.log(data);
        accessToken = data.access_token; // Сохраняем токен

        getValues();
    }
    async function getValues() {
        // Отправляем GET-запрос с токеном авторизации
        const response = await fetch('/get_values', {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${accessToken}` // Вставляем токен в заголовок
            }
        });

        const data = await response.json(); // Преобразуем ответ в JSON
        console.log(data);
        if (data.status = "success") {
            score = data.score;
            remainingTime = data.remaining_time;
            showScore();
            updateTimer();
        }
        if (!preloaderIsClose) {
            setTimeout(closePreloader, 700);
        }
    }
    async function sendMessageAboutClickToServer() {
        const response = await fetch('/click', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${accessToken}`},
            body: JSON.stringify({ user_id }),
        });
        const data = await response.json();   
        return data.status == "success";    
    }

    function updateTimer() {
        const button_text = document.getElementById('start-button-text');
        console.log(remainingTime);
        console.log("ut");
        if (remainingTime < 20 && remainingTime > 0) {
            button_text.textContent = `${remainingTime}`;
            disabled = true;
            setInterval(timer);
        } else {
            button_text.textContent = 'START';
            disabled = false;
        }
    }
    function showScore() {
        document.getElementById('score').textContent = `Score: ${score}`;
    }

    function closePreloader() {
        document.querySelector('.preloader').style.display = 'none';
        document.querySelector('.content').style.display = 'block';
        document.querySelector('footer').style.display = 'block';
    }

</script>

{% endblock %}
